```{r}
#***********************************************
# Cong Cao
# UID:704-498-691
# Date: 05/12/2017
#***********************************************
# Cong Cao 
# Clear all variables and prior sessions
rm(list=ls(all=TRUE))

# Load Libraries
library(lattice)
library(foreign)
library(MASS)
library(car)
require(stats)
require(stats4)
library(KernSmooth)
library(fastICA)
library(cluster)
library(leaps)
library(mgcv)
library(rpart)
library(pan)
library(mgcv)
library(DAAG)
library("TTR")
library(tis)
require("datasets")
require(graphics)
library("forecast")
#install.packages("astsa")
#require(astsa)
library(RColorBrewer)
library(plotrix)
library(nlstools)
library(xtable)


library(fpp)
#(a)
consumption <- data.frame(usconsumption)
consumption_ts <- ts(consumption$consumption, start=1970, frequency = 4)
t <- seq(1970, 2010, length = nrow(consumption))
plot(consumption_ts, type="l")
#(b)
plot(stl(consumption_ts,s.window="periodic"))
#(c)
par(mfrow=c(1,2))
acf(consumption_ts, main="ACF of Personal Consumption")
pacf(consumption_ts, main="PACF of Personal Consumption")
Box.test(consumption_ts,type="Ljung-Box")
Box.test(consumption_ts, type = "Box-Pierce")
#(d)
par(mfrow=c(1,1))
am33 <-arma(consumption_ts,order=c(3,3))
plot(consumption_ts,main="Plot of AR(3) and MA(3)")
lines(am33$fitted.values, col="red")
# plot of residuals 
par(mfrow=c(1,2))
plot(am33$residuals, main="Residual Plot of AR(3)MA(3)")
hist(am33$residuals,main="Residual Plot of AR(3)MA(3)")

#(e)
# two AR(p) models
ar2=arma(consumption_ts,order=c(2,0)) 
#Same as AR(2) = AR(2) + MA(0)
summary(ar2)
ar3=arma(consumption_ts,order=c(3,0)) 
#Same as AR(3) = AR(3) + MA(0)
summary(ar3)
# Compare AR models with ARMA model
par(mfrow=c(1,1))
plot(consumption_ts, type="l")
grid()
lines(am33$fitted.values, col="red")
lines(ar2$fitted.values,col="blue")
lines(ar3$fitted.values,col="seagreen2")
legend("topright",legend=c("Data","AM(3,3)","AR(3)","AR(2)"),text.col=1:4,bty="n")
par(mfrow=c(2,2))
acf(ar2$residuals[3:164], type = "correlation", main=" AR(2) Autocorrelation",lag.max=13,ylab="ACF")
acf(ar2$residuals[3:164], type = "partial",main="AR(2) Partial Autocorrelation",lag.max=13, ylab="PACF")
acf(ar3$residuals[4:164], type = "correlation", main="AR(3) Autocorrelation",lag.max=13,ylab="ACF")
acf(ar3$residuals[4:164], type = "partial",main="AR(3) Partial Autocorrelation",lag.max=13, ylab="PACF")

#######################################################################
# two MA(q) models
par(mfrow=c(1,1))
ma2=arma(consumption_ts,order=c(0,2)) 
#Same as MA(2) = AR(0) + MA(2)
summary(ma2)
ma3=arma(consumption_ts,order=c(0,3)) 
#Same as MA(3) = AR(0) + MA(3)
summary(ma3)
# Compare AR models with ARMA model
par(mfrow=c(1,1))
plot(consumption_ts, type="l")
grid()
lines(am33$fitted.values, col="red")
lines(ma2$fitted.values,col="blue")
lines(ma3$fitted.values,col="seagreen2")
legend("topright",legend=c("Data","AM(3,3)","MA(3)","MA(2)"),text.col=1:4,bty="n")
par(mfrow=c(2,2))
acf(ma2$residuals[3:164], type = "correlation", main=" MA(2) Autocorrelation",lag.max=13,ylab="ACF")
acf(ma2$residuals[3:164], type = "partial",main="MA(2) Partial Autocorrelation",lag.max=13, ylab="PACF")
acf(ma3$residuals[4:164], type = "correlation", main="MA(3) Autocorrelation",lag.max=13,ylab="ACF")
acf(ma3$residuals[4:164], type = "partial",main="MA(3) Partial Autocorrelation",lag.max=13, ylab="PACF")
par(mfrow=c(1,2))
acf(am33$residuals[4:164], type = "correlation", main=" ARMA(33) Autocorrelation",lag.max=13,ylab="ACF")
acf(am33$residuals[4:164], type = "partial",main="ARMA(33) Partial Autocorrelation",lag.max=13, ylab="PACF")



#(a) AR (3) 
par(mfrow=c(1,3))
ar3=arma(consumption_ts,order=c(3,0)) 
plot(consumption_ts, type="l")
grid()
lines(ar3$fitted.values,col="red")
legend("topright",legend=c("Data","AR(3)"),text.col=1:4,bty="n")
acf(ar3$residuals[4:164], type = "correlation", main="AR(3) Autocorrelation",lag.max=13,ylab="ACF")
acf(ar3$residuals[4:164], type = "partial",main="AR(3) Partial Autocorrelation",lag.max=13, ylab="PACF")

#(b) MA (4) 
ma4=arma(consumption_ts,order=c(0,4))
plot(consumption_ts, type="l")
grid()
lines(ma4$fitted.values,col="red")
legend("topright",legend=c("Data","MA(4)"),text.col=1:4,bty="n")
acf(ma4$residuals[5:164], type = "correlation", main="MA(4) Autocorrelation",lag.max=13,ylab="ACF")
acf(ma4$residuals[5:164], type = "partial",main="MA(4) Partial Autocorrelation",lag.max=13, ylab="PACF")

#(c) ARMA (3,2) 
am32 <-arma(consumption_ts,order=c(3,2))
plot(consumption_ts, type="l")
grid()
lines(am32$fitted.values,col="red")
legend("topright",legend=c("Data","ARMA(3,2)"),text.col=1:4,bty="n")
acf(am32$residuals[4:164], type = "correlation", main="ARMA(3,2) Autocorrelation",lag.max=13,ylab="ACF")
acf(am32$residuals[4:164], type = "partial",main="ARMA(3,2) Partial Autocorrelation",lag.max=13, ylab="PACF")
#(d) ARMA (1,1) 
am11 <-arma(consumption_ts,order=c(1,1))
plot(consumption_ts, type="l")
grid()
lines(am11$fitted.values,col="red")
legend("topright",legend=c("Data","ARMA(1,1)"),text.col=1:4,bty="n")
acf(am11$residuals[2:164], type = "correlation", main="ARMA(1,1) Autocorrelation",lag.max=13,ylab="ACF")
acf(am11$residuals[2:164], type = "partial",main="ARMA(1,1) Partial Autocorrelation",lag.max=13, ylab="PACF")

#SP500 data
data<- read.csv("Stocks.csv",header=TRUE)
d1<-as.numeric(as.matrix(data[,2:27]))
d<-matrix(d1,89,26)
#find the return of the S&P500
for(i in 1:26){
d[,i]<-rev(d[,i])}
totalreturns <- (d[-1,1:26]-d[-nrow(d),1:26])/d[-nrow(d),1:26]
sp_ts <- ts(totalreturns[,26], start=2009, frequency = 12)
t <- seq(2009, 2013, length = 12)
par(mfrow=c(1,1))
plot(sp_ts, type="l")
par(mfrow=c(1,2))
acf(sp_ts, main="ACF of S&P500")
pacf(sp_ts, main="PACF of S&P500")
par(mfrow=c(1,1))
hist(totalreturns[,26], main = "histgram of S&P500 monthly return")
Box.test(sp_ts,type="Ljung-Box")
Box.test(sp_ts, type = "Box-Pierce")


require(gdata)
d = read.xls(("Chapter7_Exercises_Data.xls"),header = T,sheet = "Exercises 3 & 4")
gper_ts<-ts(d$g_pci_california....,start = 1969, end=2002, frequency = 1)
t <- seq(1969, 2002, length =1)

plot(gper_ts, type="l")
grid()
par(mfrow=c(1,2))
acf(gper_ts, main="ACF of Income growth per capital")
pacf(gper_ts, main="PACF of Income growth per capital")
Box.test(gper_ts,type="Ljung-Box")
Box.test(gper_ts, type = "Box-Pierce")
par(mfrow=c(1,1))
aur1 <-arma(gper_ts,order=c(1,0))
plot(gper_ts,main="Plot of AR(1)")
lines(aur1$fitted.values, col="red")
summary(aur1)
```
